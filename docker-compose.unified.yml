# ============================================
# ICDA - ONE COMMAND UNIFIED BUILD
# ============================================
# RUN: docker-compose -f docker-compose.unified.yml up --build
# STOP: docker-compose -f docker-compose.unified.yml down
# CLEAN: docker-compose -f docker-compose.unified.yml down -v
# ============================================

services:
  # ============================================
  # OpenSearch - Vector Store (starts first)
  # ============================================
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: icda-opensearch
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Admin123!
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health | grep -qE '(green|yellow)'"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 30s
    restart: unless-stopped
    networks:
      - icda-network

  # ============================================
  # Redis - Cache Layer
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: icda-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    restart: unless-stopped
    networks:
      - icda-network

  # ============================================
  # ICDA Backend (FastAPI + Built Frontend)
  # Port 8000 - serves API + production frontend
  # ============================================
  icda-backend:
    build:
      context: .
      dockerfile: Dockerfile.unified
    image: icda-unified:latest
    container_name: icda-backend
    ports:
      - "8000:8000"
    environment:
      # AWS Configuration (leave empty for LITE mode)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      - NOVA_MODEL=${NOVA_MODEL:-us.amazon.nova-micro-v1:0}
      - TITAN_EMBED_MODEL=${TITAN_EMBED_MODEL:-amazon.titan-embed-text-v2:0}

      # Infrastructure (Docker service names)
      - REDIS_URL=redis://redis:6379
      - OPENSEARCH_HOST=http://opensearch:9200
      - OPENSEARCH_INDEX=${OPENSEARCH_INDEX:-customers}

      # Index Hierarchy
      - INDEX_MASTER=${INDEX_MASTER:-icda-master}
      - INDEX_CODE=${INDEX_CODE:-icda-code}
      - INDEX_KNOWLEDGE=${INDEX_KNOWLEDGE:-icda-knowledge}
      - INDEX_CUSTOMERS=${INDEX_CUSTOMERS:-icda-customers}

      # Feature Flags
      - ENABLE_FEDERATION=${ENABLE_FEDERATION:-true}
      - ENABLE_CODE_INDEX=${ENABLE_CODE_INDEX:-true}
      - ADMIN_ENABLED=${ADMIN_ENABLED:-true}

      # Gemini (optional)
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}

      # Auto-index code on startup
      - AUTO_INDEX_CODE=true
      - CODE_INDEX_PATH=/app

      # Python settings
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount knowledge folder for live updates
      - ./knowledge:/app/knowledge:ro
      # Mount customer data
      - ./customer_data.json:/app/customer_data.json:ro
    depends_on:
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - icda-network

  # ============================================
  # Frontend Dev Server (Vite HMR)
  # Port 5173 - for development with hot reload
  # ============================================
  icda-frontend-dev:
    image: node:20-alpine
    container_name: icda-frontend-dev
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - icda-network
    profiles:
      - dev

# ============================================
# Networks
# ============================================
networks:
  icda-network:
    driver: bridge
    name: icda-unified-network

# ============================================
# Volumes
# ============================================
volumes:
  redis_data:
    name: icda-unified-redis
  opensearch_data:
    name: icda-unified-opensearch
  frontend_node_modules:
    name: icda-unified-frontend-modules
